# ============================================================================
# ParkFlow Production with Docker Secrets
# ============================================================================
# Docker Swarm Mode에서 시크릿을 안전하게 관리합니다.
#
# 사전 준비:
#   1. Docker Swarm 초기화: docker swarm init
#   2. 시크릿 생성: ./scripts/create-secrets.sh
#
# 사용법:
#   docker stack deploy -c docker-compose.secrets.yml parkflow
#
# 시크릿 관리:
#   - 조회: docker secret ls
#   - 생성: docker secret create <name> <file>
#   - 삭제: docker secret rm <name>
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # API Server (with secrets)
  # ==========================================================================
  api-server:
    image: parkflow/api-server:${VERSION:-latest}
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      # Security secrets - 파일에서 읽음
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - DEVICE_API_KEY_FILE=/run/secrets/device_api_key
      - KIOSK_API_KEY_FILE=/run/secrets/kiosk_api_key
      # TossPayments secrets
      - TOSS_SECRET_KEY_FILE=/run/secrets/toss_secret_key
      - TOSS_CLIENT_KEY_FILE=/run/secrets/toss_client_key
      - TOSS_WEBHOOK_SECRET_FILE=/run/secrets/toss_webhook_secret
      # Server Configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CORS_ORIGIN=${CORS_ORIGIN:-https://admin.parkflow.io}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - REQUEST_BODY_LIMIT=${REQUEST_BODY_LIMIT:-1048576}
      - KIOSK_RATE_LIMIT=${KIOSK_RATE_LIMIT:-30}
      - PAYMENT_MODE=${PAYMENT_MODE:-live}
      # Backup Configuration
      - BACKUP_ENABLED=${BACKUP_ENABLED:-true}
      - BACKUP_DIR=/app/data/backups
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 3 * * *}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
    secrets:
      - jwt_secret
      - device_api_key
      - kiosk_api_key
      - toss_secret_key
      - toss_client_key
      - toss_webhook_secret
    volumes:
      - parkflow-data:/app/apps/api-server/data
      - parkflow-backups:/app/data/backups
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - parkflow-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ==========================================================================
  # Admin Web (Nginx)
  # ==========================================================================
  admin-web:
    image: parkflow/admin-web:${VERSION:-latest}
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - parkflow-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# Secrets
# ============================================================================
secrets:
  jwt_secret:
    external: true
  device_api_key:
    external: true
  kiosk_api_key:
    external: true
  toss_secret_key:
    external: true
  toss_client_key:
    external: true
  toss_webhook_secret:
    external: true

# ============================================================================
# Volumes
# ============================================================================
volumes:
  parkflow-data:
    driver: local
  parkflow-backups:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  parkflow-network:
    driver: overlay
    attachable: true
